# Encounter Generation Tool Code

MATLAB code that constitutes the encounter generation tool.

- [Encounter Generation Tool Code](#encounter-generation-tool-code)
  - [Overview](#overview)
  - [3rd Party Code](#3rd-party-code)
  - [Distribution Statement](#distribution-statement)

## Overview

The files in the following table are part of the Encounter Generation Tool. Note that some of the software listed is found in [`em-model-manned-bayes`](https://github.com/Airspace-Encounter-Models/em-model-manned-bayes) or [`em-core`](https://github.com/Airspace-Encounter-Models/em-core).

| Functionality  | File Name | Description |
| ------------- | ------------- |------------- |
| Run scripts for generating encounters | <ul><li>`generateDAAEncounterSet.m`</li><li>`ini2struct.m`</li><li>`load_constants.m`</li></ul>  | `generateDAAEncounterSet.m` takes in an .INI parameter file and generates a set of encounters with the characteristics specified in the parameter file. <br><br> `ini2struct.m` is a helper function for reading in parameters in the .INI file. <br><br> `load_constants.m` defines common constants for unit conversions |
| Input validation   | <ul><li>`checkEncounterModelInputs.m`</li><li>`checkINIInputs.m`</li></ul>   | `checkEncounterModelInputs.m` validates user-modified Uncorrelated Encounter Model characteristics and throws an error if there are any improperly formatted variables. <br><br> `checkINIInputs.m` validates the parameters in the .INI file and throws an error if any values are invalid. |
| Sampling from the Lincoln Uncorrelated Encounter Model  | <ul><li>`asub2ind.m`</li><li>`bn_dirichlet_prior.m`</li><li>`bn_sample.m`</li><li>`bn_sort.m`</li><li>`dbn_hierarchical_sample.m`</li><li>`dbn_sample.m`</li><li>`dediscretize.m`</li><li>`em_read.m`</li><li>`EncounterModelEvents.m`</li><li>`resample_events.m`</li><li>`select_random.m`</li></ul> | These files are used to sample trajectories from the Uncorrelated Encounter Model. <br><br>`em_read.m` is used to parse the encounter model file, which contains the Uncorrelated Encounter Model. The Uncorrelated Encounter Model parameters can be tuned to change the behavior of the intruder: see the Example_Inputs [README](../Example_Inputs/README.md#encounter-model-files) for more information. See this [paper](https://apps.dtic.mil/sti/pdfs/ADA589697.pdf) for an explanation of the parameters. <br><br>`EncounterModelEvents.m` creates an event matrix for the intruder trajectory (containing the times when updates in vertical rate/turn rate/acceleration occur). <br><br> All other files are helper functions for `dbn_hierarchical_sample.m`, which is used to sample a vector of initial values (geographic region, airspace class, altitude layer, airspeed, acceleration, vertical rate, turn rate), and a matrix of events (time, vertical rate, turn rate, acceleration) for every encounter. This [paper]( https://apps.dtic.mil/sti/pdfs/ADA589697.pdf) provides a description of how samples are generated from the Uncorrelated Encounter Model. |
| Sampling from a set of trajectories | <ul><li>`ecef_to_enu.m`</li><li>`geod_to_ecef.m`</li><li>`sampleTrajectory.m`</li><li>`upsampleTrajectory.m`</li></ui> | `sampleTrajectory.m` samples one trajectory from a set of user-defined trajectories. The directory containing the trajectories must be specified in the .INI file. Tracks may be sampled uniformly or the sampling process may be weighted so that longer tracks are more likely to be sampled than shorter tracks. Filtering can also be applied at this step such that tracks that do not satisfy minimum/maximum airspeed/altitude limits are rejected. See the Example_Inputs [README](../Example_Inputs/README.md#trajectory-files) for the expected format of these trajectories.<br><br>`geod_to_ecef.m` and `ecef_to_enu.m` are used to convert the trajectories from lat/lon to x/y (east and north). The encounters are initialized and output in terms of east and north. <br> <br> `upsampleTrajectory.m` is used to convert the input trajectories from 1 Hz to 10 Hz.|
| Initializing encounters   | <ul><li>`initializeUncorrelatedEncounter.m`</li><li>`UncorEncounterParameters.m`</li></ul>  | `initializeUncorrelatedEncounter.m` shifts and rotates the sampled ownship and intruder trajectories so that the encounter has the sampled values of HMD and VMD at CPA. <br><br> `UncorEncounterParameters.m` is a class that contains parameters used to initialize uncorrelated encounters. |
| Simulating Dynamics  | <ul><li>`minmax.h`</li><li>`run_dynamics_fast.c`</li><li>`run_dynamics_fast.mexa64`. `run_dynamics_fast.mexw64`, or `run_dynamics_fast.mexmaci64` (generated by user - see the Encounter Generation Tool [README](../README.md#mex))</li></ui>  | `run_dynamics_fast.c` is an implementation of the DEGAS dynamics in C. The mexed version of this function (`run_dynamics_fast.mexa64` for Linux,  `run_dynamics_fast.mexw64` for Windows, or  `run_dynamics_fast.mexmaci64` for Mac) is used by the Encounter Generation Tool to convert sampled encounter model events into trajectories. The dynamics constraints in `run_dynamics_fast.c` are the same as the constraints in DEGAS. Note that the user will need to mex `run_dynamics_fast.c` if any changes are made to the file (e.g., to change the constraints). <br><br> `minmax.h` is a helper function used by the dynamics.|
| Computing metadata   | <ul><li>`computeEncProperties.m`</li><li>`preallocateEncProperties.m`</li><li>`getCPAMetrics.m`</li><li>`getNominalManeuvers.m`</li></ui>  |`preallocateEncProperties.m` preallocates two structs for encounter metadata including intruder/ownship height and speed at TCA, encounter weight, and encounter duration. <br><br>`computeEncProperties.m` outputs structs populated with encounter metadata. <br><br> The function calls `getCPAMetrics.m` to compute HMD, VMD, TCA, and whether an NMAC occurs. <br><br> The function also calls `getNominalManeuvers.m` to determine whether the ownship/intruder has a nominal maneuver before TCA. A nominal maneuver is any horizontal or vertical maneuver that is in the generated ownship/intruder trajectory. These are distinct from maneuvers issued by a DAA system.|
| Outputting Encounters (Waypoints or Events)  | <ul><li>`compute_delta_heading.m`</li><li>`readTrajFiles.m`</li><li>`ScriptedEncounter.m`</li><li>`wpt2script.m`</li><li>`writeTrajectoryToFile.m`</li></ui> | Generated encounters can be output as both waypoints and Uncorrelated Encounter Model events. See the Example_Outputs [README](../Example_Outputs/README.md) for the format of these outputs.<br><br>`ScriptedEncounter.m` is a class that has all the necessary properties to define a scripted encounter – i.e., initial encounter geometry and Encounter Model events.<br><br>`wpt2script.m` is used to convert waypoints to Uncorrelated Encounter Model events. <br><br> `compute_delta_heading.m` computes turn rates from waypoints, and is a helper function for `wpt2script.m`.<br><br>`writeTrajectoryToFile.m` writes the generated ownship and intruder trajectories to a text file.<br><br>`readTrajFiles.m` can be used to read the trajectory file data into a results struct.|

## 3rd Party Code

Complete list of all third party code embedded in or accessed by the disclosed software when such software is run. This list must include, without limitation, all open source code, free executable code, public domain code, library code, and all other executable or source code not written by any of the authors, whether such code is directly embedded in the software or accessed by the software when it is executed.

The MIT airspace encounter model team has not knowingly modified any of the third party code. While the licenses vary, we include the third party code in this repository directly or as git submodules for convenience. Any modifications to git submodules ([as these git commits are separate](https://git-scm.com/book/en/v2/Git-Tools-Submodules) from this repository) shall be in compliance with their respective license.

| Code        |  Description | Software Source   | License Source  | [Git Submodule](https://git-scm.com/book/en/v2/Git-Tools-Submodules)? | Modified? |
| :-------------| :--  |:-------------| :-----| :--- | :--- |
ini2struct.m | Parses .ini file into a structure | [File Exchange](https://www.mathworks.com/matlabcentral/fileexchange/45725-ini2struct) | [BSD-3 Clause](https://www.mathworks.com/matlabcentral/fileexchange/45725-ini2struct#license_modal) | No | No
minmax.h | Min, Max macros | | GNU General Public License version 2 | No | No

## Distribution Statement

DISTRIBUTION STATEMENT A. Approved for public release. Distribution is unlimited.

© 2018, 2019, 2020, 2021 Massachusetts Institute of Technology.

This material is based upon work supported by the National Aeronautics and Space Administration under Air Force Contract No. FA8702-15-D-0001. Any opinions, findings, conclusions or recommendations expressed in this material are those of the author(s) and do not necessarily reflect the views of the National Aeronautics and Space Administration .

Delivered to the U.S. Government with Unlimited Rights, as defined in DFARS Part 252.227-7013 or 7014 (Feb 2014). Notwithstanding any copyright notice, U.S. Government rights in this work are defined by DFARS 252.227-7013 or DFARS 252.227-7014 as detailed above. Use of this work other than as specifically authorized by the U.S. Government may violate any copyrights that exist in this work.
